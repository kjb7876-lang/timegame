<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ì‹œê°„ìì›ê²Œì„" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="format-detection" content="telephone=no" />
<title>ì‹œê°„ìì› ëŒ€ì²´ì—­ì‚¬ ë³´ë“œê²Œì„ (7ë…„/í„´ Â· MDD/ì—°ìˆ˜ìµë¥  ê¸°ë°˜)</title>
  
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ì‹œê°„ìì›ê²Œì„">
<link rel="apple-touch-icon" href="icon.png">
<meta name="theme-color" content="#0b0e14">

<style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    body{margin:0;background:#0b0e14;color:#e8eefc}
    header{padding:14px 16px;background:#111827;position:sticky;top:0;z-index:10;border-bottom:1px solid #1f2a44}
    header h1{font-size:16px;margin:0;font-weight:900}
    main{padding:14px 16px 80px;max-width:1100px;margin:0 auto}
    .grid{display:grid;gap:12px}
    @media (min-width:980px){.grid.cols2{grid-template-columns:1.2fr 0.8fr}}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:#a7b0c2}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #24304f;background:#0b1224;font-size:12px}
    .btn{background:#2563eb;border:0;color:#fff;padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer}
    .btn.secondary{background:#1f2937}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    input[type="number"],select{background:#0b1224;border:1px solid #24304f;color:#e8eefc;padding:10px 10px;border-radius:12px;width:130px}
    label{font-size:12px;color:#b6c0d6}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 8px;border-bottom:1px solid #1f2a44;vertical-align:top}
    th{text-align:left;color:#b6c0d6;font-weight:900}
    .log{max-height:340px;overflow:auto;white-space:pre-wrap;background:#070b12;border:1px solid #1f2a44;padding:10px;border-radius:12px}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (min-width:760px){.kpi{grid-template-columns:repeat(5,minmax(0,1fr))}}
    .kpi .box{background:#0b1224;border:1px solid #24304f;border-radius:12px;padding:10px}
    .kpi .box .v{font-size:18px;font-weight:1000;margin-top:4px}
    .small{font-size:12px}
    .hr{height:1px;background:#1f2a44;margin:10px 0}
  
    /* ===== iPhone / Mobile UX ===== */
    html, body { height: 100%; -webkit-text-size-adjust: 100%; }
    body { padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
    header { padding-top: calc(14px + env(safe-area-inset-top)); }
    main { padding-bottom: calc(140px + env(safe-area-inset-bottom)); }

    /* Prevent iOS auto-zoom on focus: keep inputs >= 16px */
    input[type="number"], select { font-size: 16px; }

    /* More finger-friendly tap targets */
    .btn { min-height: 48px; padding: 12px 14px; font-size: 16px; border-radius: 14px; }
    .pill { padding: 8px 12px; font-size: 13px; }
    .card { border-radius: 16px; }

    /* Mobile layout tweaks */
    @media (max-width: 760px){
      main{ padding: 12px 12px calc(150px + env(safe-area-inset-bottom)); }
      header h1{ font-size: 15px; }
      .kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      input[type="number"], select { width: 100%; max-width: 100%; }
      .row{ gap: 10px; }
      table{ font-size: 12px; }
      th,td{ padding: 10px 8px; }
      .log{ max-height: 220px; }
      /* Make the allocation action row stick to bottom via dock (below) */
      #actionRowInline { display:none; }
    }

    /* Bottom dock (iPhone-style) */
    .dock{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(17,24,39,0.88);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(31,42,68,0.8);
      z-index: 9999;
    }
    .dock .dockInner{
      max-width: 1100px; margin: 0 auto;
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
      align-items: center;
    }
    .dock .dockInner .wide{ grid-column: 1 / -1; }
    .dock .dockHint{
      font-size: 12px; color: #a7b0c2; line-height: 1.25;
    }
    @media (min-width: 761px){
      .dock{ display:none; }
      #actionRowInline{ display:flex; }
      body{ padding-bottom: 0; }
      main{ padding-bottom: 80px; }
    }

</style>
</head>
<body>
<header><h1>â³ ì‹œê°„ìì› ëŒ€ì²´ì—­ì‚¬ ë³´ë“œê²Œì„ â€” 1í„´=7ë…„ Â· MDD/ì—°ìˆ˜ìµë¥  ê¸°ë°˜</h1></header>

<main class="grid cols2">
  <section class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="pill"><b>í„´</b> <span id="turnLabel">-</span></span>
          <span class="pill"><b>ì—°ë„</b> <span id="yearLabel">-</span></span>
          <span class="pill"><b>ê²½ì œ</b> <span id="regimeLabel">-</span></span>
          <span class="pill"><b>ì£¼ì‚¬ìœ„</b> <span id="diceLabel">-</span></span>
          <span class="pill"><b>ë…¸ë™íš¨ìœ¨</b> <span id="laborEffLabel" class="muted">ì ìš© í›„ ê³µê°œ</span></span>
          <span class="pill"><b>ìì‚°íš¨ìœ¨</b> <span id="assetEffLabel" class="muted">ì ìš© í›„ ê³µê°œ</span></span>
          <span class="pill"><b>ì§ˆë³‘</b> <span id="diseaseLabel">ì—†ìŒ</span></span>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnReset">ìƒˆ ê²Œì„</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpi">
        <div class="box">
          <div class="small muted">í˜„ê¸ˆ(ì‹œê°„)</div>
          <div class="v" id="cashLabel">-</div>
        </div>
        <div class="box">
          <div class="small muted">ìì‚° ì›ê¸ˆ í•©</div>
          <div class="v" id="assetTotalLabel">-</div>
        </div>
        <div class="box">
          <div class="small muted">ë²„í”„(ê²½í—˜ ëˆ„ì )</div>
          <div class="v" id="buffLabel">-</div>
        </div>
        <div class="box">
          <div class="small muted">ì´ë²ˆ í„´ í•„ìˆ˜ì†Œë¹„</div>
          <div class="v" id="consLabel">-</div>
        </div>
        <div class="box">
          <div class="small muted">ì´ ê°€ì¹˜(ì°¸ê³ )</div>
          <div class="v" id="totalValueLabel">-</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid" style="gap:10px;">
        <div>
          <div style="font-weight:900;">ğŸ“œ ê³µê°œ ì´ë²¤íŠ¸(ëŒ€ì²´ì—­ì‚¬ ì²´ê°)</div>
          <div class="small muted">ì—­ì‚¬+ê°œì¸ ì´ë²¤íŠ¸ëŠ” ëª¨ë‘ ê³µê°œ. 1í„´=7ë…„ì„ â€œí•œ ì‹œëŒ€â€ì²˜ëŸ¼ ì²´ê°.</div>
          <table>
            <thead><tr><th style="width:120px;">êµ¬ë¶„</th><th>ë‚´ìš©</th><th style="width:240px;">íš¨ê³¼</th></tr></thead>
            <tbody id="eventTable"></tbody>
          </table>
        </div>

        <div class="card" style="background:#0b1224;border-color:#24304f;">
          <div style="font-weight:900;">ğŸ§‘â€ğŸ­ ë…¸ë™ íƒ€ì…(ì‹œì‘ 1íšŒ ì„ íƒ)</div>
          <div class="small muted">ê· ë“±/ì´ˆë°˜ì§‘ì¤‘/í›„ë°˜ì§‘ì¤‘</div>
          <div class="row" style="margin-top:8px;">
            <select id="laborType">
              <option value="flat">ê· ë“±í˜•</option>
              <option value="front">ì´ˆë°˜ ì§‘ì¤‘í˜•</option>
              <option value="back">í›„ë°˜ ì§‘ì¤‘í˜•</option>
            </select>
            <button class="btn" id="btnChooseLabor">í™•ì •</button>
            <span id="laborChosenText" class="small muted"></span>
          </div>
        </div>

        <div class="card" style="background:#0b1224;border-color:#24304f;">
          <div style="font-weight:900;">ğŸ›ï¸ ì´ë²ˆ í„´ ë°°ë¶„ (í˜„ê¸ˆâ†”ìì‚° êµí™˜)</div>
          <div class="small muted">ì£¼ì‚¬ìœ„ëŠ” ê³µê°œ, íš¨ìœ¨(ë…¸ë™/ìì‚°)ì€ â€œì ìš© í›„â€ ê³µê°œ.</div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <div><label>ë…¸ë™ íˆ¬ì…</label><br/><input id="allocLabor" type="number" min="0" step="1" value="12"/></div>
              <div><label>ê²½í—˜ íˆ¬ì…</label><br/><input id="allocExp" type="number" min="0" step="1" value="8"/></div>
            </div>
            <div class="small muted">ë‚¨ëŠ” ì‹œê°„ì€ í˜„ê¸ˆ ìœ ì§€</div>
          </div>

          <div class="hr"></div>

          <div style="font-weight:900;margin-bottom:6px;">ğŸ“ˆ ë§¤ìˆ˜(í˜„ê¸ˆâ†’ìì‚°)</div>
          <div class="row">
            <div><label>ì£¼ì‹</label><br/><input id="buyStock" type="number" min="0" step="1" value="8"/></div>
            <div><label>ê¸ˆ</label><br/><input id="buyGold" type="number" min="0" step="1" value="4"/></div>
            <div><label>ì±„ê¶Œ</label><br/><input id="buyBond" type="number" min="0" step="1" value="4"/></div>
          </div>

          <div class="hr"></div>

          <div style="font-weight:900;margin-bottom:6px;">ğŸ’± ë§¤ë„(ìì‚°â†’í˜„ê¸ˆ, 1:1)</div>
          <div class="small muted">ë§¤ë„ëŠ” í„´ ì‹œì‘ì— ì¦‰ì‹œ ë°˜ì˜.</div>
          <div class="row" style="margin-top:8px;">
            <div><label>ì£¼ì‹</label><br/><input id="sellStock" type="number" min="0" step="1" value="0"/></div>
            <div><label>ê¸ˆ</label><br/><input id="sellGold" type="number" min="0" step="1" value="0"/></div>
            <div><label>ì±„ê¶Œ</label><br/><input id="sellBond" type="number" min="0" step="1" value="0"/></div>
          </div>

          <div class="hr"></div>

          <div class="row" id="actionRowInline" style="justify-content:space-between;">
            <div class="row">
              <button class="btn" id="btnRoll">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
              <button class="btn" id="btnResolve" disabled>í„´ ì§„í–‰(7ë…„)</button>
            </div>
            <div class="small muted" id="allocHint"></div>
          </div>

          <div class="small muted" style="margin-top:8px;">
            âœ… ì§ˆë³‘ì€ <b>ì´ë²ˆ í„´(7ë…„)</b>ì—ë§Œ 1íšŒ ì ìš©
          </div>
        </div>
      </div>
    </div>
  </section>

  <aside class="grid">
    <div class="card">
      <div style="font-weight:900;">ğŸ¦ ë³´ìœ  ìì‚°(ì›ê¸ˆ)</div>
      <div class="small muted">ìˆ˜ìµë¥ ì€ 7ë…„ ë‹¨ìœ„ë¡œ í¬ê²Œ ì›€ì§ì„ (MDD ê¸°ë°˜ ë³€ë™ì„±)</div>
      <div class="hr"></div>
      <table>
        <thead><tr><th>ìì‚°</th><th>ì›ê¸ˆ</th><th>ëª¨ë¸ ê¸°ì¤€(ì—°)</th></tr></thead>
        <tbody id="holdingTable"></tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:900;">ğŸŒ ê²½ì œìƒí™© ë“±ì¥í™•ë¥ </div>
      <div class="small muted">ë¬¼ê°€ ëª©í‘œ(2~3%)ê°€ ëŒ€ë¶€ë¶„, ë””í”Œë ˆëŠ” ë“œë¬¼ê³  ìŠ¤íƒœê·¸ëŠ” ê°€ë”.</div>
      <div class="hr"></div>
      <table>
        <thead><tr><th>ìƒí™©</th><th>í™•ë¥ </th><th>ì—° ë¬¼ê°€ ë²”ìœ„</th></tr></thead>
        <tbody id="regimeProbTable"></tbody>
      </table>
    </div>

    <div class="card">
      <div style="font-weight:900;">ğŸ§¾ ì—°ëŒ€ê¸° ë¡œê·¸</div>
      <div class="small muted">í•œ í„´=7ë…„ì´ë¯€ë¡œ â€œì‹œëŒ€ ìš”ì•½â€ì²˜ëŸ¼ ê¸°ë¡ë¨.</div>
      <div class="hr"></div>
      <div class="log" id="log"></div>
    </div>
  </aside>
</main>

<script>
const TURN_YEARS = 7;

const CONFIG = {
  totalTurns: 10,
  startYear: 1960,
  startCash: 100,

  regimes: [
    { key:"target", label:"ë¬¼ê°€ëª©í‘œ(2~3%)", p:0.82, inflationRange:[0.02, 0.03] },
    { key:"deflation", label:"ë””í”Œë ˆì´ì…˜", p:0.06, inflationRange:[-0.02, 0.00] },
    { key:"stagflation", label:"ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜", p:0.12, inflationRange:[0.04, 0.08] },
  ],

  assets: {
    stock: { name:"ì£¼ì‹", mu:0.096, mdd:0.58 },
    bond:  { name:"ì±„ê¶Œ", mu:0.049, mdd:0.127 },
    gold:  { name:"ê¸ˆ",   mu:0.050, mdd:0.54 },
  },

  sigmaFromMDD: (mdd)=> Math.max(0.01, mdd/3.0),

  regimeMuAdjust: {
    target:     { stock: +0.00, bond:+0.00, gold:+0.00 },
    deflation:  { stock: -0.05, bond:+0.02, gold:+0.01 },
    stagflation:{ stock: -0.08, bond:-0.04, gold:+0.06 },
  },

  laborPerTime: 1.0,

  laborSchedule(turnIndex, totalTurns, type){
    const t = turnIndex, N = totalTurns;
    if(type==="flat") return 1.00;
    if(type==="front"){
      const start=1.35, end=0.75, a=(t-1)/(N-1);
      return start + (end-start)*a;
    }
    if(type==="back"){
      const start=0.75, end=1.35, a=(t-1)/(N-1);
      return start + (end-start)*a;
    }
    return 1.0;
  },

  baseConsumption: { target:18, deflation:14, stagflation:26 },

  expBasePosChance: 0.52,
  expBuffGain: 0.08,
  expNegLossRate: 0.55,

  diceToLaborEff(d){ return 0.90 + d*0.04; },
  diceToAssetEff(d){ return 0.75 + d*0.09; },

  // âœ… ì—¬ê¸°(ì½¤ë§ˆ ìœ„ì¹˜) ì˜¤ë¥˜ ìˆ˜ì •ë¨
  disease: {
    overworkTiers: [
      { min:0.70, p:0.35, laborMult:0.70, assetMult:0.95 },
      { min:0.55, p:0.20, laborMult:0.82, assetMult:0.98 },
      { min:0.35, p:0.10, laborMult:0.92, assetMult:1.00 },
      { min:0.00, p:0.00, laborMult:1.00, assetMult:1.00 },
    ],
    mentalTiers: [
      { max:0,  p:0.30, allMult:0.78, consAdd:3 },
      { max:4,  p:0.18, allMult:0.86, consAdd:2 },
      { max:9,  p:0.08, allMult:0.93, consAdd:1 },
      { max:999999, p:0.00, allMult:1.00, consAdd:0 },
    ]
  },

  historicalEvents: [
    { name:"ì—ë„ˆì§€ ì¶©ê²©", flavor:"ê³µê¸‰ ì¶©ê²©ìœ¼ë¡œ ë¹„ìš© ì••ë°•ì´ ì»¤ì§„ë‹¤.", w:0.18, effects:{ consAdd:+4, laborMult:0.97 } },
    { name:"ê¸°ìˆ  ë„ì•½", flavor:"ìƒì‚°ì„±ê³¼ ìë³¸ íš¨ìœ¨ì´ í•¨ê»˜ ì˜¤ë¥¸ë‹¤.", w:0.18, effects:{ laborMult:1.05, assetMuAdd:{stock:+0.02} } },
    { name:"ê¸ˆìœµ ë¶ˆì•ˆ", flavor:"ìœ„í—˜ìì‚° ë³€ë™ì„±ì´ í™•ëŒ€ëœë‹¤.", w:0.16, effects:{ assetSigmaMult:{stock:1.15} } },
    { name:"ì œë„ ì•ˆì •", flavor:"ì•ˆì „ë§ì´ ê°•í™”ë¼ í•„ìˆ˜ì§€ì¶œì´ ì¼ë¶€ ì™„í™”ëœë‹¤.", w:0.16, effects:{ consAdd:-2 } },
    { name:"ì¡°ìš©í•œ ì‹œëŒ€", flavor:"í° ì‚¬ê±´ ì—†ì´ êµ¬ì¡°ê°€ ìœ ì§€ëœë‹¤.", w:0.32, effects:{ } },
  ],
  personalEvents: [
    { name:"í•™ì—…/ìê²©", flavor:"ì—­ëŸ‰ ê°•í™”. ì¥ê¸° ìƒì‚°ì„±ì— ë„ì›€.", w:0.18, effects:{ expPosChanceAdd:+0.08, laborMult:1.02 } },
    { name:"ì‹¤ì§/ê³µë°±", flavor:"ì»¤ë¦¬ì–´ ë‹¨ì ˆ. ë…¸ë™ íš¨ìœ¨ì´ êº¾ì¸ë‹¤.", w:0.10, effects:{ laborMult:0.72, consAdd:+1 } },
    { name:"ì¶œì‚°/ë¶€ì–‘", flavor:"ê¸°ì¨ê³¼ ë¶€ë‹´ì´ ë™ì‹œì— ëŠ˜ì–´ë‚œë‹¤.", w:0.10, effects:{ consAdd:+5, laborMult:0.96 } },
    { name:"ì§ˆë³‘(ê°œì¸)", flavor:"í° ë³‘ì€ ì•„ë‹ˆì§€ë§Œ ì»¨ë””ì…˜ì´ ë–¨ì–´ì§„ë‹¤.", w:0.10, effects:{ laborMult:0.92 } },
    { name:"ì°½ì—…/ë„ì „", flavor:"ë¦¬ìŠ¤í¬ë¥¼ ë– ì•ˆê³  íŒì„ í‚¤ìš´ë‹¤.", w:0.12, effects:{ assetMuAdd:{stock:+0.01}, consAdd:+2 } },
    { name:"ë¬´ì‚¬", flavor:"íŠ¹ë³„í•œ ê°œì¸ ì‚¬ê±´ ì—†ìŒ.", w:0.40, effects:{ } },
  ]
};

/** ===== ìœ í‹¸ ===== */
const $ = (id)=>document.getElementById(id);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const fmt=(n)=>Number.isFinite(n)?(Math.abs(n)>=1000?n.toLocaleString("ko-KR"):String(Math.round(n))):"-";
function pickByProb(list){
  let r=Math.random();
  for(const it of list){ r-=it.p; if(r<=0) return it; }
  return list[list.length-1];
}
function pickWeighted(list){
  const sum=list.reduce((s,x)=>s+x.w,0);
  let r=Math.random()*sum;
  for(const it of list){ r-=it.w; if(r<=0) return it; }
  return list[list.length-1];
}
function randN(){
  let u=0,v=0;
  while(u===0) u=Math.random();
  while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function lognormalReturn(muAnnual, sigmaAnnual, years){
  const sigma = sigmaAnnual;
  const muLog = Math.log(1+muAnnual) - 0.5*sigma*sigma;
  const z = randN();
  const logR = (muLog*years) + (sigma*Math.sqrt(years)*z);
  const gross = Math.exp(logR);
  return gross - 1;
}

/** ===== ìƒíƒœ ===== */
const game = {
  laborLocked:false,
  laborType:"flat",
  turn:0,
  year:CONFIG.startYear,
  cash:CONFIG.startCash,
  holdings:{stock:0,gold:0,bond:0},
  buff:0,
  regime:null,
  inflation:null,
  dice:null,
  laborEff:null,
  assetEff:null,
  events:{hist:null, pers:null},
  cons:0,
  diseaseText:"ì—†ìŒ",
  log:[]
};

const assetKeys=["stock","gold","bond"];
const totalAsset=()=>assetKeys.reduce((s,k)=>s+game.holdings[k],0);
const totalValue=()=>game.cash+totalAsset();

/** ===== í„´ ì¤€ë¹„ ===== */
function calcConsumption(){
  const base = CONFIG.baseConsumption[game.regime.key];
  const he = game.events.hist.effects||{};
  const pe = game.events.pers.effects||{};
  return Math.max(0, Math.round(base + (he.consAdd||0) + (pe.consAdd||0)));
}
function nextTurn(){
  game.turn += 1;
  game.year = CONFIG.startYear + (game.turn-1)*TURN_YEARS;

  game.regime = pickByProb(CONFIG.regimes);
  const [a,b]=game.regime.inflationRange;
  game.inflation = a + Math.random()*(b-a);

  game.events.hist = pickWeighted(CONFIG.historicalEvents);
  game.events.pers = pickWeighted(CONFIG.personalEvents);

  game.dice=null;
  game.laborEff=null;
  game.assetEff=null;
  game.diseaseText="ì—†ìŒ";

  game.cons = calcConsumption();

  game.log.push(`\n[${game.year}ë…„ëŒ€ / ${game.turn}í„´(â‰ˆ${TURN_YEARS}ë…„)] ê²½ì œ: ${game.regime.label} (ì—° ë¬¼ê°€â‰ˆ${(game.inflation*100).toFixed(1)}%)`);
  game.log.push(`- ì—­ì‚¬: ${game.events.hist.name} / ê°œì¸: ${game.events.pers.name}`);
}

/** ===== ì§ˆë³‘(ì´ë²ˆ í„´ë§Œ) ===== */
function rollDisease(laborAlloc, expAlloc, buySum){
  let laborMult=1.0, assetMult=1.0, allMult=1.0, consAdd=0;
  const spend = laborAlloc + expAlloc + buySum;
  let tag=[];

  if(spend>0){
    const ratio = laborAlloc / spend;
    for(const t of CONFIG.disease.overworkTiers){
      if(ratio >= t.min){
        if(Math.random() < t.p){
          laborMult *= t.laborMult;
          assetMult *= t.assetMult;
          tag.push("ì‹ ì²´(ê³¼ë¡œ)");
        }
        break;
      }
    }
  }

  for(const t of CONFIG.disease.mentalTiers){
    if(expAlloc <= t.max){
      if(Math.random() < t.p){
        allMult *= t.allMult;
        consAdd += t.consAdd;
        tag.push("ì •ì‹ (ë²ˆì•„ì›ƒ)");
      }
      break;
    }
  }

  return {
    laborMult: laborMult*allMult,
    assetMult: assetMult*allMult,
    consAdd,
    label: tag.length?tag.join(" + "):"ì—†ìŒ"
  };
}

/** ===== ì£¼ì‚¬ìœ„ ===== */
function rollDice(){
  game.dice = 1 + Math.floor(Math.random()*6);
  game.log.push(`- ì£¼ì‚¬ìœ„(ê³µê°œ): ${game.dice} (íš¨ìœ¨ì€ ì ìš© í›„ ê³µê°œ)`);
  $("btnRoll").disabled=true;
  $("btnResolve").disabled=false;
  render();
}

/** ===== í„´ ì²˜ë¦¬ ===== */
function resolveTurn(){
  if(game.dice==null) return;

  const laborAlloc = clamp(parseInt($("allocLabor").value||"0",10),0,999999);
  const expAlloc   = clamp(parseInt($("allocExp").value||"0",10),0,999999);

  const buyStock = clamp(parseInt($("buyStock").value||"0",10),0,999999);
  const buyGold  = clamp(parseInt($("buyGold").value||"0",10),0,999999);
  const buyBond  = clamp(parseInt($("buyBond").value||"0",10),0,999999);
  const buySum = buyStock+buyGold+buyBond;

  const sellStock = clamp(parseInt($("sellStock").value||"0",10),0,999999);
  const sellGold  = clamp(parseInt($("sellGold").value||"0",10),0,999999);
  const sellBond  = clamp(parseInt($("sellBond").value||"0",10),0,999999);
  const sellSum = sellStock+sellGold+sellBond;

  if(sellStock>game.holdings.stock){alert("ì£¼ì‹ ë§¤ë„ëŸ‰ì´ ë³´ìœ ë¥¼ ì´ˆê³¼");return;}
  if(sellGold>game.holdings.gold){alert("ê¸ˆ ë§¤ë„ëŸ‰ì´ ë³´ìœ ë¥¼ ì´ˆê³¼");return;}
  if(sellBond>game.holdings.bond){alert("ì±„ê¶Œ ë§¤ë„ëŸ‰ì´ ë³´ìœ ë¥¼ ì´ˆê³¼");return;}

  // ë§¤ë„
  if(sellSum>0){
    game.holdings.stock -= sellStock;
    game.holdings.gold  -= sellGold;
    game.holdings.bond  -= sellBond;
    game.cash += sellSum;
    game.log.push(`- ë§¤ë„: ì£¼ì‹${sellStock}, ê¸ˆ${sellGold}, ì±„ê¶Œ${sellBond} â†’ í˜„ê¸ˆ +${sellSum}`);
  }

  const spend = laborAlloc+expAlloc+buySum;
  if(spend>game.cash){alert(`ì§€ì¶œ(${spend})ì´ í˜„ê¸ˆ(${game.cash}) ì´ˆê³¼`);return;}
  game.cash -= spend;

  const he = game.events.hist.effects||{};
  const pe = game.events.pers.effects||{};

  // ì§ˆë³‘(ì´ë²ˆ í„´ë§Œ)
  const disease = rollDisease(laborAlloc, expAlloc, buySum);
  game.diseaseText = disease.label;

  // ì£¼ì‚¬ìœ„ íš¨ìœ¨
  let laborEff = CONFIG.diceToLaborEff(game.dice);
  let assetEff = CONFIG.diceToAssetEff(game.dice);

  // ë…¸ë™ì†Œë“
  const sched = CONFIG.laborSchedule(game.turn, CONFIG.totalTurns, game.laborType);
  const laborMult = (he.laborMult||1)*(pe.laborMult||1)*sched*(1+game.buff)*disease.laborMult;
  const laborIncome = Math.round(laborAlloc * CONFIG.laborPerTime * laborMult * laborEff);
  game.cash += laborIncome;

  // ë§¤ìˆ˜
  game.holdings.stock += buyStock;
  game.holdings.gold  += buyGold;
  game.holdings.bond  += buyBond;

  // ê²½í—˜
  const expPosChance = clamp(CONFIG.expBasePosChance + (he.expPosChanceAdd||0) + (pe.expPosChanceAdd||0), 0.05, 0.95);
  let expText="ì—†ìŒ";
  if(expAlloc>0){
    if(Math.random()<expPosChance){
      const gain = CONFIG.expBuffGain * Math.sqrt(expAlloc/10);
      game.buff = Math.round((game.buff + gain)*100)/100;
      expText = `í”ŒëŸ¬ìŠ¤(ë²„í”„ +${gain.toFixed(2)} â†’ ${game.buff.toFixed(2)})`;
    }else{
      const loss = Math.round(expAlloc * CONFIG.expNegLossRate * laborEff);
      game.cash -= loss;
      expText = `ë§ˆì´ë„ˆìŠ¤(ì¶”ê°€ ì†Œëª¨ ${loss})`;
    }
  }

  // ìì‚°(7ë…„) ìˆ˜ìµë¥  ì ìš©
  const adj = CONFIG.regimeMuAdjust[game.regime.key] || {};
  const before = {...game.holdings};
  const rLog = {};

  const assetMuAdd = Object.assign({}, (he.assetMuAdd||{}), (pe.assetMuAdd||{}));
  const assetSigmaMult = Object.assign({}, (he.assetSigmaMult||{}), (pe.assetSigmaMult||{}));

  for(const k of assetKeys){
    const base = CONFIG.assets[k];
    const mu = (base.mu + (adj[k]||0) + (assetMuAdd[k]||0));
    const sigma = CONFIG.sigmaFromMDD(base.mdd) * (assetSigmaMult[k]||1);

    const r7 = lognormalReturn(mu, sigma, TURN_YEARS);
    const applied = r7 * (1+game.buff) * assetEff * disease.assetMult;

    game.holdings[k] = Math.max(0, Math.round(game.holdings[k] * (1 + applied)));
    rLog[k] = r7;
  }

  // ì†Œë¹„(ì§ˆë³‘ ì¶”ê°€ ë°˜ì˜)
  game.cons = calcConsumption() + (disease.consAdd||0);
  game.cash -= game.cons;

  game.laborEff = Math.round(laborEff*100)/100;
  game.assetEff = Math.round(assetEff*100)/100;

  game.log.push(`- íš¨ìœ¨(ê³µê°œ): ë…¸ë™ x${game.laborEff} / ìì‚° x${game.assetEff} / ì§ˆë³‘: ${game.diseaseText}`);
  game.log.push(`- ë…¸ë™: íˆ¬ì…${laborAlloc} â†’ +${laborIncome}`);
  game.log.push(`- ê²½í—˜: íˆ¬ì…${expAlloc} â†’ ${expText}`);
  game.log.push(`- ì‹œì¥(7ë…„) ìˆ˜ìµë¥ (ìƒ˜í”Œ): ì£¼ì‹ ${(rLog.stock*100).toFixed(1)}% / ê¸ˆ ${(rLog.gold*100).toFixed(1)}% / ì±„ê¶Œ ${(rLog.bond*100).toFixed(1)}%`);
  game.log.push(`- ìì‚° ë³€í™”: ì£¼ì‹ ${before.stock}â†’${game.holdings.stock}, ê¸ˆ ${before.gold}â†’${game.holdings.gold}, ì±„ê¶Œ ${before.bond}â†’${game.holdings.bond}`);
  game.log.push(`- í•„ìˆ˜ì†Œë¹„(7ë…„ì¹˜): -${game.cons}`);

  if(game.cash<=0){
    endGame(false, "í˜„ê¸ˆ(ì‹œê°„ìì›)ì´ 0 ì´í•˜ê°€ ë˜ì–´ íƒˆë½í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  $("btnResolve").disabled=true;
  $("btnRoll").disabled=false;
  $("sellStock").value=0; $("sellGold").value=0; $("sellBond").value=0;

  if(game.turn>=CONFIG.totalTurns){
    endGame(true, "ëª¨ë“  í„´(=ì‹œëŒ€)ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    return;
  }

  nextTurn();
  render();
}

function endGame(finished, msg){
  game.log.push(`\n=== ê²Œì„ ì¢…ë£Œ ===`);
  game.log.push(msg);
  game.log.push(`ìµœì¢… í˜„ê¸ˆ: ${game.cash}`);
  game.log.push(`ìµœì¢… ìì‚° í•©: ${totalAsset()}`);
  game.log.push(`ì´ ê°€ì¹˜: ${totalValue()}`);
  $("btnRoll").disabled=true;
  $("btnResolve").disabled=true;
  render();
  alert(`${msg}\n\nìµœì¢… í˜„ê¸ˆ: ${game.cash}\nìì‚° í•©: ${totalAsset()}\nì´ ê°€ì¹˜: ${totalValue()}`);
}

/** ===== ë Œë” ===== */
function renderEventRow(type, ev){
  const eff=ev.effects||{};
  const parts=[];
  if(eff.laborMult!=null) parts.push(`ë…¸ë™ x${eff.laborMult}`);
  if(eff.consAdd!=null) parts.push(`í•„ìˆ˜ì†Œë¹„ ${eff.consAdd>=0?"+":""}${eff.consAdd}`);
  if(eff.expPosChanceAdd!=null) parts.push(`ê²½í—˜+í™•ë¥  ${eff.expPosChanceAdd>=0?"+":""}${eff.expPosChanceAdd}`);
  if(eff.assetMuAdd) parts.push(`ìì‚°mu+(${Object.keys(eff.assetMuAdd).join(",")})`);
  if(eff.assetSigmaMult) parts.push(`ë³€ë™ì„±x(${Object.keys(eff.assetSigmaMult).join(",")})`);
  return `<tr>
    <td>${type}</td>
    <td><b>${ev.name}</b><div class="small muted">${ev.flavor||""}</div></td>
    <td class="small">${parts.length?parts.join(", "):"ë³€í™” ì—†ìŒ"}</td>
  </tr>`;
}

function render(){
  $("turnLabel").textContent = `${game.turn}/${CONFIG.totalTurns}`;
  $("yearLabel").textContent = `${game.year}ë…„ëŒ€`;
  $("regimeLabel").textContent = game.regime?`${game.regime.label}`:"-";
  $("diceLabel").textContent = game.dice==null?"-":String(game.dice);

  if(game.laborEff!=null){ $("laborEffLabel").textContent=`x${game.laborEff}`; $("laborEffLabel").classList.remove("muted"); }
  else { $("laborEffLabel").textContent="ì ìš© í›„ ê³µê°œ"; $("laborEffLabel").classList.add("muted"); }

  if(game.assetEff!=null){ $("assetEffLabel").textContent=`x${game.assetEff}`; $("assetEffLabel").classList.remove("muted"); }
  else { $("assetEffLabel").textContent="ì ìš© í›„ ê³µê°œ"; $("assetEffLabel").classList.add("muted"); }

  $("diseaseLabel").textContent = game.diseaseText;

  $("cashLabel").textContent = fmt(game.cash);
  $("assetTotalLabel").textContent = fmt(totalAsset());
  $("buffLabel").textContent = `+${game.buff.toFixed(2)}`;
  $("consLabel").textContent = fmt(game.cons);
  $("totalValueLabel").textContent = fmt(totalValue());

  $("laborChosenText").textContent = game.laborLocked
    ? `í™•ì •ë¨: ${$("laborType").selectedOptions[0].textContent}`
    : "ë¯¸í™•ì •";

  $("eventTable").innerHTML = [
    renderEventRow("ì—­ì‚¬", game.events.hist||{name:"-",flavor:"",effects:{}}),
    renderEventRow("ê°œì¸", game.events.pers||{name:"-",flavor:"",effects:{}})
  ].join("");

  const s = CONFIG.sigmaFromMDD(CONFIG.assets.stock.mdd);
  const b = CONFIG.sigmaFromMDD(CONFIG.assets.bond.mdd);
  const g = CONFIG.sigmaFromMDD(CONFIG.assets.gold.mdd);

  $("holdingTable").innerHTML = `
    <tr><td>ì£¼ì‹</td><td>${fmt(game.holdings.stock)}</td><td class="muted">mu ${(CONFIG.assets.stock.mu*100).toFixed(1)}% / sigmaâ‰ˆ${(s*100).toFixed(1)}%</td></tr>
    <tr><td>ê¸ˆ</td><td>${fmt(game.holdings.gold)}</td><td class="muted">mu ${(CONFIG.assets.gold.mu*100).toFixed(1)}% / sigmaâ‰ˆ${(g*100).toFixed(1)}%</td></tr>
    <tr><td>ì±„ê¶Œ</td><td>${fmt(game.holdings.bond)}</td><td class="muted">mu ${(CONFIG.assets.bond.mu*100).toFixed(1)}% / sigmaâ‰ˆ${(b*100).toFixed(1)}%</td></tr>
  `;

  $("regimeProbTable").innerHTML = CONFIG.regimes.map(r=>{
    return `<tr>
      <td><b>${r.label}</b></td>
      <td>${Math.round(r.p*100)}%</td>
      <td class="muted">${(r.inflationRange[0]*100).toFixed(1)}% ~ ${(r.inflationRange[1]*100).toFixed(1)}%</td>
    </tr>`;
  }).join("");

  const laborAlloc = parseInt($("allocLabor").value||"0",10)||0;
  const expAlloc   = parseInt($("allocExp").value||"0",10)||0;
  const buySum =
    (parseInt($("buyStock").value||"0",10)||0) +
    (parseInt($("buyGold").value||"0",10)||0) +
    (parseInt($("buyBond").value||"0",10)||0);
  const sellSum =
    (parseInt($("sellStock").value||"0",10)||0) +
    (parseInt($("sellGold").value||"0",10)||0) +
    (parseInt($("sellBond").value||"0",10)||0);

  const available = game.cash + sellSum;
  const spend = laborAlloc + expAlloc + buySum;
  const after = available - spend;
  $("allocHint").textContent = after>=0
    ? `ë§¤ë„ +${sellSum} â†’ ì‚¬ìš©ê°€ëŠ¥ ${available} / ì§€ì¶œ ${spend} / ë‚¨ìŒ ${after}`
    : `âš ï¸ ì‚¬ìš©ê°€ëŠ¥ ${available} < ì§€ì¶œ ${spend} (ë¶€ì¡± ${-after})`;

  $("log").textContent = game.log.join("\n");
}

/** ===== ë¦¬ì…‹/ì‹œì‘ ===== */
function resetGame(){
  game.laborLocked=false;
  game.laborType="flat";
  game.turn=0;
  game.year=CONFIG.startYear;
  game.cash=CONFIG.startCash;
  game.holdings={stock:0,gold:0,bond:0};
  game.buff=0;
  game.regime=null;
  game.inflation=null;
  game.dice=null;
  game.laborEff=null;
  game.assetEff=null;
  game.events={hist:null,pers:null};
  game.cons=0;
  game.diseaseText="ì—†ìŒ";
  game.log=[`ê²Œì„ ì‹œì‘: í˜„ê¸ˆ(ì‹œê°„) ${CONFIG.startCash} / 1í„´â‰ˆ${TURN_YEARS}ë…„`];

  $("laborType").disabled=false;
  $("btnChooseLabor").disabled=false;
  $("btnRoll").disabled=false;
  $("btnResolve").disabled=true;

  nextTurn();
  render();
}

/** ===== UI ===== */
$("btnReset").addEventListener("click", resetGame);
$("btnChooseLabor").addEventListener("click", ()=>{
  game.laborType = $("laborType").value;
  game.laborLocked=true;
  $("laborType").disabled=true;
  $("btnChooseLabor").disabled=true;
  game.log.push(`- ë…¸ë™ íƒ€ì… í™•ì •: ${$("laborType").selectedOptions[0].textContent}`);
  render();
});
$("btnRoll").addEventListener("click", rollDice);
$("btnResolve").addEventListener("click", resolveTurn);

["allocLabor","allocExp","buyStock","buyGold","buyBond","sellStock","sellGold","sellBond"].forEach(id=>{
  $(id).addEventListener("input", render);
});


/** ===== Mobile Dock Hooks (iPhone UX) ===== */
function syncMobileDock(){
  const mr = document.getElementById("mResolve");
  const mroll = document.getElementById("mRoll");
  const mreset = document.getElementById("mReset");
  const mhint = document.getElementById("mHint");
  if(!mr || !mroll || !mreset) return;

  // mirror disabled states
  mroll.disabled = document.getElementById("btnRoll").disabled;
  mr.disabled = document.getElementById("btnResolve").disabled;

  // mirror hint
  const hint = document.getElementById("allocHint").textContent || "";
  mhint.textContent = hint ? hint : "ë°°ë¶„ì„ ì…ë ¥í•œ ë’¤ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ê³ , í„´ ì§„í–‰ì„ ëˆ„ë¥´ì„¸ìš”.";
}

document.getElementById("mReset")?.addEventListener("click", ()=>document.getElementById("btnReset").click());
document.getElementById("mRoll")?.addEventListener("click", ()=>document.getElementById("btnRoll").click());
document.getElementById("mResolve")?.addEventListener("click", ()=>document.getElementById("btnResolve").click());

// keep dock state synced after any render
const _render = render;
render = function(){
  _render();
  syncMobileDock();
};

resetGame();
</script>

<div class="dock" aria-label="ëª¨ë°”ì¼ ì¡°ì‘ ë°”">
  <div class="dockInner">
    <button class="btn secondary" id="mReset">ìƒˆ ê²Œì„</button>
    <button class="btn" id="mRoll">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
    <button class="btn wide" id="mResolve" disabled>í„´ ì§„í–‰(7ë…„)</button>
    <div class="dockHint wide" id="mHint">ë°°ë¶„ì„ ì…ë ¥í•œ ë’¤ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ê³ , í„´ ì§„í–‰ì„ ëˆ„ë¥´ì„¸ìš”.</div>
  </div>
</div>


<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>

</body>
</html>
